name: CI for Iris Pipeline

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install pytest>=8.0.0,<9 dvc==2.53.0 cml==0.16.0 scikit-learn==1.3.2 pandas==2.1.1 joblib==1.3.2

    - name: Pull data and model
      run: |
        echo "Fetching data and model with DVC..."
        dvc pull || echo "⚠️ No DVC remote found or not configured"
        ls -R

    - name: Run Sanity Test and Pytest
      run: |
        echo "Running sanity check..."
        python --version
        ls
        pytest -v > test_report.txt || true

    - name: Post CML Report
      if: github.event_name == 'pull_request'
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "### 🧪 CI Sanity Test and Pytest Report" > report.md
        cat test_report.txt >> report.md
        cml comment create report.md

